name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          python3-dev \
          build-essential \
          pkg-config \
          zip \
          unzip \
          libncursesw6 \
          libtinfo6 \
          libstdc++6 \
          libffi-dev \
          libssl-dev \
          libsqlite3-dev \
          openjdk-17-jdk

    - name: Install Cython, Buildozer, Python-for-Android
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython
        python -m pip install buildozer
        python -m pip install python-for-android

    - name: Install Android SDK + Build-tools (robust, avoids broken pipe)
      shell: bash
      run: |
        set -euo pipefail

        export ANDROID_SDK_ROOT="$HOME/android-sdk"
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"

        # download command line tools and unpack
        CMDLINE_ZIP="commandlinetools.zip"
        wget -q "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip" -O "$CMDLINE_ZIP"
        unzip -q "$CMDLINE_ZIP"

        # Ensure a clean target folder
        mkdir -p cmdline-tools
        rm -rf cmdline-tools/latest
        mkdir -p cmdline-tools/latest

        # Move contents safely (handles both zip layouts)
        if [ -d cmdline-tools/cmdline-tools ]; then
          echo "Detected nested cmdline-tools/cmdline-tools; moving its contents into cmdline-tools/latest"
          for item in cmdline-tools/cmdline-tools/*; do
            [ -e "$item" ] || continue
            mv "$item" cmdline-tools/latest/ || true
          done
          rm -rf cmdline-tools/cmdline-tools
        else
          echo "Detected cmdline-tools/* layout; moving its contents into cmdline-tools/latest"
          for item in cmdline-tools/*; do
            [ -e "$item" ] || continue
            # avoid moving the 'latest' folder itself if it exists
            if [ "$item" = "cmdline-tools/latest" ]; then
              continue
            fi
            mv "$item" cmdline-tools/latest/ || true
          done
        fi

        # verify sdkmanager exists
        if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "ERROR: sdkmanager not found or not executable at $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          exit 1
        fi

        # Accept licenses safely (avoid failing due to broken pipe)
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

        # Install required packages (no piping yes; licenses already accepted above)
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.2"

    - name: Set ANDROID_HOME and PATH
      run: |
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "PATH=$HOME/android-sdk/platform-tools:$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Build APK
      run: |
        buildozer android debug --verbose

name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Keep python version as requested; SDK root inside repository workspace
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          python3-dev \
          build-essential \
          pkg-config \
          zip \
          unzip \
          libncursesw6 \
          libtinfo6 \
          libstdc++6 \
          libffi-dev \
          libssl-dev \
          libsqlite3-dev \
          openjdk-17-jdk

    - name: Install Cython, Buildozer, Python-for-Android
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython
        python -m pip install buildozer
        python -m pip install python-for-android

    - name: Install Android SDK command-line tools (robust)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"

        CMDLINE_ZIP="commandlinetools.zip"
        wget -q "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip" -O "$CMDLINE_ZIP"
        unzip -q "$CMDLINE_ZIP"

        mkdir -p cmdline-tools
        rm -rf cmdline-tools/latest
        mkdir -p cmdline-tools/latest

        if [ -d cmdline-tools/cmdline-tools ]; then
          for item in cmdline-tools/cmdline-tools/*; do
            [ -e "$item" ] || continue
            mv "$item" cmdline-tools/latest/ || true
          done
          rm -rf cmdline-tools/cmdline-tools
        else
          for item in cmdline-tools/*; do
            [ -e "$item" ] || continue
            if [ "$item" = "cmdline-tools/latest" ]; then
              continue
            fi
            mv "$item" cmdline-tools/latest/ || true
          done
        fi

        if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "ERROR: sdkmanager not found at $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          exit 1
        fi

        # Accept licenses (ignore broken-pipe non-zero exit)
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

    - name: Install platform-tools and build-tools
      shell: bash
      run: |
        set -euo pipefail
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.2"

        echo "Installed build-tools:"
        ls -la "$ANDROID_SDK_ROOT/build-tools" || true

    - name: Persist ANDROID env for later steps
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Symlink Buildozer expected SDK location to installed SDK
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.buildozer/android/platform"
        ln -sfn "$ANDROID_SDK_ROOT" "$HOME/.buildozer/android/platform/android-sdk"
        echo "Symlink created:"
        ls -la "$HOME/.buildozer/android/platform" || true

    - name: Create compatibility shim for tools/bin/sdkmanager and build-tools/platform-tools
      shell: bash
      run: |
        set -euo pipefail
        ANDROID_HOME="${ANDROID_SDK_ROOT:-$HOME/android-sdk}"
        # Ensure Buildozer expected parents exist
        mkdir -p "$HOME/.buildozer/android/platform/android-sdk/tools/bin"
        # Symlink the real sdkmanager into Buildozer's expected location
        if [ -x "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
          ln -sfn "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" \
            "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager"
          chmod +x "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager" || true
        else
          echo "WARN: real sdkmanager not found at $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
        fi
        # Also make build-tools and platform-tools visible in Buildozer path
        if [ -d "$ANDROID_HOME/build-tools" ]; then
          ln -sfn "$ANDROID_HOME/build-tools" "$HOME/.buildozer/android/platform/android-sdk/build-tools"
        fi
        if [ -d "$ANDROID_HOME/platform-tools" ]; then
          ln -sfn "$ANDROID_HOME/platform-tools" "$HOME/.buildozer/android/platform/android-sdk/platform-tools"
        fi
        echo "Contents of Buildozer SDK shim:"
        ls -la "$HOME/.buildozer/android/platform/android-sdk" || true
        echo "sdkmanager (shim) version:"
        "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager" --version || true

    - name: Sanity check:show aidl path
      run: |
        echo "Searching for aidl..."
        find "$ANDROID_SDK_ROOT" -type f -name aidl -print -ls || true
        find "$HOME/.buildozer/android/platform/android-sdk" -type f -name aidl -print -ls || true

    - name: Build APK
      run: |
        buildozer android debug --verbose

name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # SDK inside repo workspace (used by steps below)
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      # host Python used for build tools in CI (must be a supported runner version)
      HOST_PYTHON: "3.11"

    steps:
    - name: Checkout repository (no submodules)
      uses: actions/checkout@v3
      with:
        # avoid submodule initialization to prevent errors with broken .gitmodules
        submodules: false
        fetch-depth: 0

    - name: Quick cleanup of committed caches (CI-only)
      shell: bash
      run: |
        rm -rf .buildozer || true
        rm -rf bin || true

    - name: Safely remove broken SDL2 submodule entry (CI-only)
      shell: bash
      run: |
        # defensive: if .gitmodules contains the broken entry, remove it from the working copy
        if [ -f .gitmodules ] && grep -q 'p4a_dependencies/SDL2' .gitmodules; then
          git config -f .gitmodules --remove-section submodule.p4a_dependencies/SDL2 2>/dev/null || true
          # if .gitmodules becomes empty, remove it so later git submodule code doesn't fail
          if [ ! -s .gitmodules ]; then
            git rm --cached -f .gitmodules 2>/dev/null || true
          else
            git add .gitmodules 2>/dev/null || true
          fi
          git commit -m "CI: remove broken p4a_dependencies/SDL2 submodule" || true
        fi

    - name: Set up host Python (CI)
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.HOST_PYTHON }}

    - name: Install required OS packages (common native deps)
      shell: bash
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          build-essential git python3-dev pkg-config zip unzip \
          libncursesw6 libtinfo6 libstdc++6 libffi-dev libssl-dev \
          libsqlite3-dev openjdk-17-jdk \
          libjpeg-dev zlib1g-dev libfreetype6-dev libpng-dev \
          curl

    - name: Install pip tools: Cython, buildozer, python-for-android
      shell: bash
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython buildozer python-for-android

    - name: Remove problematic hardcoded paths from buildozer.spec (CI-safe)
      shell: bash
      run: |
        # Comment out absolute path keys which break CI (android.sdk_path, android.ndk_path, p4a.hostpython_dir, p4a.local_python)
        if [ -f buildozer.spec ]; then
          sed -i 's/^[[:space:]]*android\.sdk_path.*/# &/' buildozer.spec || true
          sed -i 's/^[[:space:]]*android\.ndk_path.*/# &/' buildozer.spec || true
          sed -i 's/^[[:space:]]*p4a\.hostpython_dir.*/# &/' buildozer.spec || true
          sed -i 's/^[[:space:]]*p4a\.local_python.*/# &/' buildozer.spec || true
        fi

    - name: Download & install Android cmdline-tools (robust)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"
        CMDLINE="commandlinetools.zip"
        curl -fsSL -o "$CMDLINE" "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
        unzip -q "$CMDLINE"
        # ensure cmdline-tools/latest layout (handle zip layout differences)
        mkdir -p cmdline-tools
        rm -rf cmdline-tools/latest
        mkdir -p cmdline-tools/latest
        if [ -d cmdline-tools/cmdline-tools ]; then
          for f in cmdline-tools/cmdline-tools/*; do [ -e "$f" ] || continue; mv "$f" cmdline-tools/latest/ || true; done
          rm -rf cmdline-tools/cmdline-tools
        else
          for f in cmdline-tools/*; do [ -e "$f" ] || continue; if [ "$f" = "cmdline-tools/latest" ]; then continue; fi; mv "$f" cmdline-tools/latest/ || true; done
        fi
        if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "sdkmanager not found at expected path"
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          exit 1
        fi
        # Accept licenses (ignore non-zero broken-pipe)
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

    - name: Install platform-tools, build-tools and NDK (with retries)
      shell: bash
      run: |
        set -euo pipefail
        BIN="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        PACKAGES=("platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653")
        for i in 1 2 3; do
          echo "Attempt $i to install SDK packages..."
          "$BIN" --sdk_root="$ANDROID_SDK_ROOT" "${PACKAGES[@]}" && break || {
            echo "sdkmanager install failed; retrying after sleep..."
            sleep $((i*6))
          }
        done
        ls -la "$ANDROID_SDK_ROOT/build-tools" || true
        ls -la "$ANDROID_SDK_ROOT/ndk" || true

    - name: Persist ANDROID env for following steps
      shell: bash
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Create Buildozer compatibility shim (tools/bin/sdkmanager + build-tools)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.buildozer/android/platform"
        ln -sfn "$ANDROID_SDK_ROOT" "$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$HOME/.buildozer/android/platform/android-sdk/tools/bin"
        if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager"
          chmod +x "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager" || true
        fi
        ln -sfn "$ANDROID_SDK_ROOT/build-tools" "$HOME/.buildozer/android/platform/android-sdk/build-tools" || true
        ln -sfn "$ANDROID_SDK_ROOT/platform-tools" "$HOME/.buildozer/android/platform/android-sdk/platform-tools" || true
        ln -sfn "$ANDROID_SDK_ROOT/ndk" "$HOME/.buildozer/android/platform/android-sdk/ndk" || true
        ls -la "$HOME/.buildozer/android/platform/android-sdk" || true

    - name: Sanity check - find aidl and ndk
      shell: bash
      run: |
        find "$ANDROID_SDK_ROOT" -type f -name aidl -print -ls || true
        ls -la "$ANDROID_SDK_ROOT/ndk" || true

    - name: Ensure buildozer.spec has log_level = 2
      shell: bash
      run: |
        if [ -f buildozer.spec ]; then
          if grep -q "^[[:space:]]*\\[buildozer\\]" buildozer.spec; then
            if grep -q "^[[:space:]]*log_level" buildozer.spec; then
              sed -i 's/^[[:space:]]*log_level.*/log_level = 2/' buildozer.spec || true
            else
              awk '/^\[buildozer\]/{print; print "log_level = 2"; next}1' buildozer.spec > buildozer.spec.tmp && mv buildozer.spec.tmp buildozer.spec || true
            fi
          else
            echo -e "\n[buildozer]\nlog_level = 2" >> buildozer.spec
          fi
        fi

    - name: Debug versions & environment
      shell: bash
      run: |
        python --version || true
        python -m pip --version || true
        python -m pip show python-for-android || true
        python -m pip show buildozer || true
        java -version || true
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --version || true
        ls -la "$ANDROID_SDK_ROOT" || true

    - name: Build APK (capture full log)
      shell: bash
      run: |
        set -x
        # capture full output to buildozer.log
        buildozer android debug --verbose 2>&1 | tee buildozer.log

    - name: Collect APKs (if any)
      shell: bash
      run: |
        mkdir -p apk-artifacts
        find . -type f -name "*.apk" -exec cp --parents {} apk-artifacts/ \; || true
        cp -v bin/*.apk apk-artifacts/ 2>/dev/null || true
        ls -la apk-artifacts || true

    - name: Upload buildozer.log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-log
        path: buildozer.log

    - name: Upload APK artifacts (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifacts
        path: apk-artifacts

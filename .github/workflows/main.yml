name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # SDK inside repo workspace (kept simple for cache/visibility)
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      # Recommended python-for-android works best with 3.10/3.11 on CI; app runtime is determined by p4a recipe
      PYTHON_VERSION: 3.10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Quick cleanup of committed caches (CI-only)
      shell: bash
      run: |
        rm -rf .buildozer || true
        rm -rf bin || true

    - name: Remove broken SDL2 submodule entry (CI workaround)
      shell: bash
      run: |
        set -euo pipefail
        if [ -f .gitmodules ] && grep -q 'p4a_dependencies/SDL2' .gitmodules; then
          git submodule deinit -f -- p4a_dependencies/SDL2 2>/dev/null || true
          git rm --cached -f p4a_dependencies/SDL2 2>/dev/null || true
          git config -f .gitmodules --remove-section submodule.p4a_dependencies/SDL2 2>/dev/null || true
          if [ ! -s .gitmodules ]; then
            git rm --cached -f .gitmodules 2>/dev/null || true
          else
            git add .gitmodules 2>/dev/null || true
          fi
          git commit -m "CI: remove broken p4a_dependencies/SDL2 submodule" || true
        fi

    - name: Set up Python (p4a-friendly)
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install OS build dependencies (extra libs for native packages)
      shell: bash
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          python3-dev build-essential pkg-config zip unzip \
          libncursesw6 libtinfo6 libstdc++6 libffi-dev libssl-dev \
          libsqlite3-dev openjdk-17-jdk \
          libjpeg-dev zlib1g-dev libfreetype6-dev libpng-dev

    - name: Install Cython, Buildozer, python-for-android
      shell: bash
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython buildozer python-for-android

    - name: Remove problematic hardcoded paths from buildozer.spec (CI-safe)
      shell: bash
      run: |
        # If your buildozer.spec has hardcoded absolute paths, they break CI.
        # We comment out these lines so Buildozer uses defaults in CI.
        if [ -f buildozer.spec ]; then
          echo "Commenting out absolute-path keys (android.sdk_path, android.ndk_path, p4a.hostpython_dir, p4a.local_python) in buildozer.spec"
          sed -i 's/^[[:space:]]*android\.sdk_path.*$/# &/' buildozer.spec || true
          sed -i 's/^[[:space:]]*android\.ndk_path.*$/# &/' buildozer.spec || true
          sed -i 's/^[[:space:]]*p4a\.hostpython_dir.*$/# &/' buildozer.spec || true
          sed -i 's/^[[:space:]]*p4a\.local_python.*$/# &/' buildozer.spec || true
          sed -n '1,200p' buildozer.spec || true
        else
          echo "No buildozer.spec found in repo root â€” build will fail without it."
        fi

    - name: Install Android SDK command-line tools (robust)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"

        CMDLINE_ZIP="commandlinetools.zip"
        echo "Downloading command-line tools..."
        wget -q "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip" -O "$CMDLINE_ZIP"
        echo "Unzipping..."
        unzip -q "$CMDLINE_ZIP"

        # Prepare cmdline-tools/latest reliably (handle different zip layouts)
        mkdir -p cmdline-tools
        rm -rf cmdline-tools/latest
        mkdir -p cmdline-tools/latest

        if [ -d cmdline-tools/cmdline-tools ]; then
          echo "Detected nested cmdline-tools/cmdline-tools layout"
          for item in cmdline-tools/cmdline-tools/*; do
            [ -e "$item" ] || continue
            mv "$item" cmdline-tools/latest/ || true
          done
          rm -rf cmdline-tools/cmdline-tools
        else
          echo "Detected cmdline-tools/* layout"
          for item in cmdline-tools/*; do
            [ -e "$item" ] || continue
            if [ "$item" = "cmdline-tools/latest" ]; then
              continue
            fi
            mv "$item" cmdline-tools/latest/ || true
          done
        fi

        if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "ERROR: sdkmanager not found at $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          exit 1
        fi

        # Accept licenses (ignore non-zero broken-pipe)
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

    - name: Install platform-tools, build-tools and NDK (with retries)
      shell: bash
      run: |
        set -euo pipefail
        SDKBIN="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        # packages to install - include NDK r25c (25.2.9519653)
        pkgs=(
          "platform-tools"
          "platforms;android-33"
          "build-tools;33.0.2"
          "ndk;25.2.9519653"
        )
        # retry loop (network/SdKserver can be flaky)
        for i in 1 2 3; do
          echo "sdkmanager attempt $i: installing ${pkgs[*]}"
          "$SDKBIN" --sdk_root="$ANDROID_SDK_ROOT" "${pkgs[@]}" && break || {
            echo "sdkmanager failed on attempt $i; retrying after sleep..."
            sleep $(( i * 5 ))
          }
        done
        echo "Installed SDK packages (listing build-tools):"
        ls -la "$ANDROID_SDK_ROOT/build-tools" || true
        echo "NDK folders:"
        ls -la "$ANDROID_SDK_ROOT/ndk" || true

    - name: Persist ANDROID env
      shell: bash
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Symlink Buildozer expected SDK path (compat shim)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.buildozer/android/platform"
        ln -sfn "$ANDROID_SDK_ROOT" "$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$HOME/.buildozer/android/platform/android-sdk/tools/bin"
        if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager"
          chmod +x "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager" || true
        fi
        if [ -d "$ANDROID_SDK_ROOT/build-tools" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/build-tools" "$HOME/.buildozer/android/platform/android-sdk/build-tools"
        fi
        if [ -d "$ANDROID_SDK_ROOT/platform-tools" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/platform-tools" "$HOME/.buildozer/android/platform/android-sdk/platform-tools"
        fi
        if [ -d "$ANDROID_SDK_ROOT/ndk" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/ndk" "$HOME/.buildozer/android/platform/android-sdk/ndk"
        fi
        echo "Buildozer shim contents:"
        ls -la "$HOME/.buildozer/android/platform/android-sdk" || true

    - name: Sanity check - ensure aidl / ndk exist
      shell: bash
      run: |
        echo "Searching for aidl and ndk directories:"
        find "$ANDROID_SDK_ROOT" -maxdepth 4 -type f -name aidl -print -ls || true
        ls -la "$ANDROID_SDK_ROOT/ndk" || true
        ls -la "$HOME/.buildozer/android/platform/android-sdk/ndk" || true

    - name: Ensure buildozer.spec log_level = 2
      shell: bash
      run: |
        if [ -f buildozer.spec ]; then
          if grep -q "^[[:space:]]*\\[buildozer\\]" buildozer.spec; then
            if grep -q "^[[:space:]]*log_level" buildozer.spec; then
              sed -i 's/^[[:space:]]*log_level.*/log_level = 2/' buildozer.spec || true
            else
              awk '/^\[buildozer\]/{print; print "log_level = 2"; next}1' buildozer.spec > buildozer.spec.tmp && mv buildozer.spec.tmp buildozer.spec || true
            fi
          else
            echo -e "\n[buildozer]\nlog_level = 2" >> buildozer.spec
          fi
        fi

    - name: Debug versions (diagnostics)
      shell: bash
      run: |
        python --version || true
        python -m pip --version || true
        python -m pip show python-for-android || true
        python -m pip show buildozer || true
        java -version || true
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --version || true
        echo "Top-level SDK contents:"
        ls -la "$ANDROID_SDK_ROOT" || true

    - name: Build APK (capture full log)
      shell: bash
      run: |
        set -x
        # run buildozer and capture full log (stdout+stderr) into buildozer.log
        buildozer android debug --verbose 2>&1 | tee buildozer.log

    - name: Collect APKs (if any)
      shell: bash
      run: |
        mkdir -p apk-artifacts
        find . -type f -name "*.apk" -exec cp --parents {} apk-artifacts/ \; || true
        cp -v bin/*.apk apk-artifacts/ 2>/dev/null || true
        ls -la apk-artifacts || true

    - name: Upload buildozer.log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-log
        path: buildozer.log

    - name: Upload APK artifacts (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifacts
        path: apk-artifacts

name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Quick cleanup of committed caches (CI-only)
      shell: bash
      run: |
        # Remove committed .buildozer or bin folders that may contain absolute paths
        rm -rf .buildozer || true
        rm -rf bin || true

    - name: Remove broken SDL2 submodule entry (CI workaround)
      shell: bash
      run: |
        set -euo pipefail
        if [ -f .gitmodules ] && grep -q 'p4a_dependencies/SDL2' .gitmodules; then
          echo "Found p4a_dependencies/SDL2 in .gitmodules — removing submodule entry for CI run."
          git submodule deinit -f -- p4a_dependencies/SDL2 2>/dev/null || true
          git rm --cached -f p4a_dependencies/SDL2 2>/dev/null || true
          git config -f .gitmodules --remove-section submodule.p4a_dependencies/SDL2 2>/dev/null || true
          if [ ! -s .gitmodules ]; then
            git rm --cached -f .gitmodules 2>/dev/null || true
          else
            git add .gitmodules 2>/dev/null || true
          fi
          git commit -m "CI: remove broken p4a_dependencies/SDL2 submodule" || true
          echo "Broken submodule entry removed for this CI run."
        else
          echo "No SDL2 submodule entry found in .gitmodules — continuing."
        fi

    - name: Set up Python (p4a-friendly)
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Build Dependencies
      shell: bash
      run: |
        sudo apt update
        sudo apt install -y \
          python3-dev \
          build-essential \
          pkg-config \
          zip \
          unzip \
          libncursesw6 \
          libtinfo6 \
          libstdc++6 \
          libffi-dev \
          libssl-dev \
          libsqlite3-dev \
          openjdk-17-jdk

    - name: Install Cython, Buildozer, python-for-android
      shell: bash
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install Cython buildozer python-for-android

    - name: Install Android SDK command-line tools (robust)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"

        echo "Downloading command-line tools..."
        wget -q "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip" -O cmdline-tools.zip
        echo "Unzipping..."
        unzip -q cmdline-tools.zip

        # Prepare cmdline-tools/latest reliably (handle different zip layouts)
        mkdir -p cmdline-tools
        rm -rf cmdline-tools/latest
        mkdir -p cmdline-tools/latest

        if [ -d cmdline-tools/cmdline-tools ]; then
          echo "Detected nested cmdline-tools/cmdline-tools layout"
          for item in cmdline-tools/cmdline-tools/*; do
            [ -e "$item" ] || continue
            mv "$item" cmdline-tools/latest/ || true
          done
          rm -rf cmdline-tools/cmdline-tools
        else
          echo "Detected cmdline-tools/* layout"
          for item in cmdline-tools/*; do
            [ -e "$item" ] || continue
            if [ "$item" = "cmdline-tools/latest" ]; then
              continue
            fi
            mv "$item" cmdline-tools/latest/ || true
          done
        fi

        if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "ERROR: sdkmanager not found at $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          exit 1
        fi

        # Accept licenses (ignore broken-pipe non-zero exit)
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

    - name: Install platform-tools and build-tools
      shell: bash
      run: |
        set -euo pipefail
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.2"
        echo "Installed build-tools:"
        ls -la "$ANDROID_SDK_ROOT/build-tools" || true

    - name: Persist ANDROID env
      shell: bash
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Symlink Buildozer expected SDK path (compat shim)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.buildozer/android/platform"
        ln -sfn "$ANDROID_SDK_ROOT" "$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$HOME/.buildozer/android/platform/android-sdk/tools/bin"

        # create sdkmanager shim
        if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager"
          chmod +x "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager" || true
        fi

        # ensure build-tools and platform-tools visible to Buildozer path
        if [ -d "$ANDROID_SDK_ROOT/build-tools" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/build-tools" "$HOME/.buildozer/android/platform/android-sdk/build-tools"
        fi
        if [ -d "$ANDROID_SDK_ROOT/platform-tools" ]; then
          ln -sfn "$ANDROID_SDK_ROOT/platform-tools" "$HOME/.buildozer/android/platform/android-sdk/platform-tools"
        fi

        echo "Buildozer SDK shim contents:"
        ls -la "$HOME/.buildozer/android/platform/android-sdk" || true
        "$HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager" --version || true

    - name: Sanity check - ensure aidl exists
      shell: bash
      run: |
        echo "Searching for aidl..."
        find "$ANDROID_SDK_ROOT" -type f -name aidl -print -ls || true
        find "$HOME/.buildozer/android/platform/android-sdk" -type f -name aidl -print -ls || true

    - name: Ensure buildozer.spec log_level = 2
      shell: bash
      run: |
        if [ -f buildozer.spec ]; then
          if grep -q "^[[:space:]]*\\[buildozer\\]" buildozer.spec; then
            if grep -q "^[[:space:]]*log_level" buildozer.spec; then
              sed -i 's/^[[:space:]]*log_level.*/log_level = 2/' buildozer.spec || true
            else
              awk '/^\[buildozer\]/{print; print "log_level = 2"; next}1' buildozer.spec > buildozer.spec.tmp && mv buildozer.spec.tmp buildozer.spec || true
            fi
          else
            echo -e "\n[buildozer]\nlog_level = 2" >> buildozer.spec
          fi
          echo "Updated buildozer.spec (last 20 lines):"
          tail -n 20 buildozer.spec || true
        else
          echo "buildozer.spec not found; continuing (buildozer will fail if missing)."
        fi

    - name: Debug versions (diagnostics)
      shell: bash
      run: |
        python --version || true
        python -m pip --version || true
        python -m pip show python-for-android || true
        python -m pip show buildozer || true
        java -version || true
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --version || true
        echo "Top-level SDK contents:"
        ls -la "$ANDROID_SDK_ROOT" || true

    - name: Build APK (capture full log)
      shell: bash
      run: |
        set -x
        # build and capture full log
        buildozer android debug --verbose 2>&1 | tee buildozer.log

    - name: Collect APKs (if any)
      shell: bash
      run: |
        mkdir -p apk-artifacts
        # Search common Buildozer output locations for APKs and copy
        find . -type f -name "*.apk" -exec cp --parents {} apk-artifacts/ \; || true
        # Also try bin/
        cp -v bin/*.apk apk-artifacts/ 2>/dev/null || true
        ls -la apk-artifacts || true

    - name: Upload buildozer.log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-log
        path: buildozer.log

    - name: Upload APK artifacts (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifacts
        path: apk-artifacts
